<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>知识笔记</title>
  <link rel="stylesheet" href="sidebar.css">
</head>
<body>
  <div class="sidebar-container" id="sidebarContainer">
    <!-- 调整大小的拖拽条 -->
    <div class="resize-handle" id="resizeHandle"></div>
    
    <!-- 侧边栏内容 -->
    <div class="sidebar-content">
      <!-- 头部 -->
      <header class="sidebar-header">
        <div class="header-left">
          <h1>📝 知识笔记</h1>
          <div class="view-tabs">
            <button class="tab-btn active" id="notesTab" data-view="notes">笔记</button>
            <button class="tab-btn" id="libraryTab" data-view="library">文档库</button>
          </div>
        </div>
        <div class="header-actions">
          <button id="addNoteBtn" class="btn-icon" title="添加笔记">+</button>
          <div class="more-actions-wrapper">
            <button id="moreActionsBtn" class="btn-icon" title="更多操作">⋮</button>
            <div class="more-actions-menu" id="moreActionsMenu">
              <button class="menu-item" id="positionBtn">
                <span class="menu-icon">⇄</span>
                <span class="menu-text">切换位置</span>
              </button>
              <button class="menu-item" id="exportBtn">
                <span class="menu-icon">📥</span>
                <span class="menu-text">导出数据</span>
              </button>
              <button class="menu-item" id="importBtn">
                <span class="menu-icon">📤</span>
                <span class="menu-text">导入数据</span>
              </button>
              <button class="menu-item" id="restoreBtn">
                <span class="menu-icon">🔄</span>
                <span class="menu-text">恢复数据</span>
              </button>
              <button class="menu-item" id="backupSettingsBtn">
                <span class="menu-icon">💾</span>
                <span class="menu-text">备份设置</span>
              </button>
              <button class="menu-item menu-item-danger" id="clearAllBtn" style="display: none;">
                <span class="menu-icon">🗑️</span>
                <span class="menu-text">清空所有数据</span>
              </button>
            </div>
          </div>
          <button id="closeBtn" class="btn-icon" title="关闭">×</button>
        </div>
      </header>

      <!-- 笔记视图 -->
      <div class="view-content" id="notesView">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="搜索笔记...">
        </div>

        <div class="notes-container" id="notesContainer">
          <!-- 笔记列表将在这里动态生成 -->
        </div>

        <div class="empty-state" id="emptyState">
          <p>还没有笔记</p>
          <p class="hint">点击"添加"按钮保存当前页面内容</p>
          <div id="emptyStateRestore" class="empty-state-restore" style="display: none; margin-top: 16px;">
            <button class="btn-primary" id="emptyStateRestoreBtn">从备份恢复数据</button>
          </div>
        </div>
      </div>

      <!-- 文档库视图 -->
      <div class="view-content hidden" id="libraryView">
        <div class="library-stats">
          <div class="stat-item">
            <div class="stat-value" id="totalNotes">0</div>
            <div class="stat-label">总笔记数</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalImages">0</div>
            <div class="stat-label">总图片数</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="storageSize">0 KB</div>
            <div class="stat-label">存储大小</div>
          </div>
        </div>

        <div class="library-categories" id="libraryCategories">
          <!-- 分类按钮将在这里动态生成 -->
        </div>

        <div class="library-list" id="libraryList">
          <!-- 文档库列表将在这里显示 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 添加笔记弹窗 -->
  <div class="modal" id="addNoteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>添加笔记</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="noteTitle">标题</label>
          <input type="text" id="noteTitle" placeholder="输入笔记标题">
        </div>
        <div class="form-group">
          <label for="noteUrl">网址</label>
          <input type="text" id="noteUrl" placeholder="自动填充当前页面网址">
        </div>
        <div class="form-group form-group-textarea">
          <div class="textarea-header">
            <label for="noteText">文本内容</label>
            <button type="button" id="toggleTextExpandBtn" class="text-expand-btn" aria-pressed="false">展开</button>
          </div>
          <textarea id="noteText" rows="10" placeholder="输入或粘贴文本内容..."></textarea>
        </div>
        <div class="form-group">
          <label for="noteCategory">分类</label>
          <input type="text" id="noteCategory" placeholder="输入分类（可选）" list="categoryList">
          <datalist id="categoryList"></datalist>
        </div>
        <div class="form-group">
          <label for="noteTags">标签</label>
          <div class="tags-input-container">
            <input type="text" id="noteTagsInput" placeholder="输入标签，按回车添加" class="tags-input">
            <div class="tags-display" id="tagsDisplay"></div>
          </div>
        </div>
        <div class="form-group">
          <label>图片</label>
          <div class="image-upload-area" id="imageUploadArea">
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
            <button type="button" id="selectImageBtn" class="btn-secondary">选择图片</button>
            <div class="image-preview" id="imagePreview"></div>
          </div>
        </div>
        <div class="form-group">
          <button type="button" id="capturePageBtn" class="btn-secondary">📸 捕获当前页面</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelBtn">取消</button>
        <button class="btn-primary" id="saveNoteBtn">保存</button>
      </div>
    </div>
  </div>

  <!-- 查看笔记详情弹窗 -->
  <div class="modal" id="viewNoteModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-actions">
          <button class="btn-secondary modal-icon-btn" id="editNoteBtn" title="编辑" aria-label="编辑">✎</button>
          <button class="btn-danger modal-icon-btn" id="deleteNoteBtn" title="删除" aria-label="删除">🗑</button>
          <button class="btn-secondary modal-icon-btn" id="closeViewBtn" title="关闭" aria-label="关闭">×</button>
        </div>
        <h2 id="viewNoteTitle"></h2>
      </div>
      <div class="modal-body" id="viewNoteBody">
        <!-- 笔记详情将在这里显示 -->
      </div>
    </div>
  </div>


  <!-- 下载数据弹窗 -->
  <div class="modal" id="downloadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="downloadModalTitle">下载数据</h2>
        <button class="close-btn" id="closeDownloadModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" id="downloadModeRow">
          <label for="downloadModeSelect">下载方式</label>
          <select id="downloadModeSelect">
            <option value="batch">批量下载（每条笔记一个文件）</option>
            <option value="merged">合并下载（所有笔记一个文件）</option>
          </select>
          <div class="form-hint">批量下载可能触发浏览器多文件下载提示。</div>
        </div>
        <div class="form-group">
          <label for="downloadFormatSelect">文件格式</label>
          <select id="downloadFormatSelect"></select>
        </div>
        <div class="form-group" id="downloadImagesRow">
          <label class="checkbox-label">
            <input type="checkbox" id="downloadIncludeImages">
            包含图片（文件会更大）
          </label>
        </div>
        <div class="form-group" id="cloudServiceRow">
          <label>导出到云服务</label>
          <div class="cloud-services-buttons">
            <button type="button" class="btn-cloud-service" id="exportToGoogleDriveBtn" title="导出到 Google Drive">
              📁 Google Drive
            </button>
            <button type="button" class="btn-cloud-service" id="exportToNotionBtn" title="导出到 Notion">
              📝 Notion
            </button>
            <button type="button" class="btn-cloud-service" id="exportToObsidianBtn" title="导出到 Obsidian">
              🔗 Obsidian
            </button>
          </div>
          <div class="form-hint">需要先配置云服务（点击设置按钮）</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cloudSettingsBtn">云服务设置</button>
        <button class="btn-secondary" id="cancelDownloadBtn">取消</button>
        <button class="btn-primary" id="confirmDownloadBtn">开始下载</button>
      </div>
    </div>
  </div>

  <!-- 备份设置弹窗 -->
  <div class="modal" id="backupSettingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>备份设置</h2>
        <button class="close-btn" id="closeBackupSettingsBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <h3>自动备份</h3>
          <label class="checkbox-label" for="autoBackupEnabled">
            <input type="checkbox" id="autoBackupEnabled">
            启用自动备份
          </label>
          <div class="form-hint">每次保存笔记后自动创建备份文件</div>
        </div>
        
        <div class="form-group backup-setting-group" id="backupLocationGroup">
          <label for="backupLocation">备份位置</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="backupLocation" placeholder="选择备份文件夹..." readonly style="flex: 1;">
            <button type="button" class="btn-secondary" id="selectBackupFolderBtn">选择文件夹</button>
          </div>
          <div class="form-hint">选择本地文件夹用于保存备份文件</div>
        </div>

        <div class="form-group backup-setting-group" id="backupFrequencyGroup">
          <label for="backupFrequency">备份频率</label>
          <select id="backupFrequency">
            <option value="every-save">每次保存</option>
            <option value="daily">每天一次</option>
            <option value="weekly">每周一次</option>
            <option value="manual">仅手动备份</option>
          </select>
        </div>

        <div class="form-group">
          <h3>云端备份（可选）</h3>
          <label class="checkbox-label" for="cloudBackupEnabled">
            <input type="checkbox" id="cloudBackupEnabled">
            自动备份到 Google Drive
          </label>
          <div class="form-hint">需要先配置 Google Drive（在云服务设置中）</div>
        </div>

        <div class="form-group">
          <h3>手动备份</h3>
          <button type="button" class="btn-primary" id="createBackupBtn">立即创建备份</button>
          <div class="form-hint">手动创建当前所有数据的备份文件</div>
        </div>

        <div class="form-group">
          <div id="backupStatus" class="service-status" style="display: none;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="closeBackupSettingsBtn2">关闭</button>
        <button class="btn-primary" id="saveBackupSettingsBtn">保存设置</button>
      </div>
    </div>
  </div>

  <!-- 恢复数据弹窗 -->
  <div class="modal" id="restoreModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>恢复数据</h2>
        <button class="close-btn" id="closeRestoreModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <p>选择备份文件来恢复数据：</p>
          <div class="restore-drop-zone" id="restoreDropZone">
            <p>📁 拖拽备份文件到这里</p>
            <p class="hint">或点击下方按钮选择文件</p>
          </div>
          <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
          <button type="button" class="btn-secondary" id="selectRestoreFileBtn" style="margin-top: 12px;">选择备份文件</button>
        </div>
        <div class="form-group">
          <label class="checkbox-label" for="restoreMergeMode">
            <input type="checkbox" id="restoreMergeMode" checked>
            合并模式（保留现有笔记）
          </label>
          <div class="form-hint">取消勾选将替换所有现有数据</div>
        </div>
        <div class="form-group">
          <div id="restoreStatus" class="service-status" style="display: none;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelRestoreBtn">取消</button>
        <button class="btn-primary" id="confirmRestoreBtn" disabled>恢复数据</button>
      </div>
    </div>
  </div>

  <!-- 首次启动提示弹窗 -->
  <div class="modal" id="firstLaunchModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>欢迎使用知识笔记</h2>
      </div>
      <div class="modal-body">
        <p>这是您首次使用本扩展，或者检测到没有已保存的笔记。</p>
        <p>如果您之前使用过本扩展并创建了备份，可以立即恢复数据：</p>
        <div style="margin-top: 16px;">
          <button class="btn-primary" id="firstLaunchRestoreBtn">从备份恢复</button>
          <button class="btn-secondary" id="firstLaunchSkipBtn" style="margin-left: 8px;">跳过，开始使用</button>
        </div>
        <div class="form-hint" style="margin-top: 16px;">
          <strong>提示：</strong>建议定期备份数据，避免卸载扩展后数据丢失。可以在"备份设置"中配置自动备份。
        </div>
      </div>
    </div>
  </div>

  <!-- 云服务设置弹窗 -->
  <div class="modal" id="cloudSettingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>云服务设置</h2>
        <button class="close-btn" id="closeCloudSettingsBtn">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Google Drive 设置 -->
        <div class="form-group">
          <h3>Google Drive</h3>
          <label for="googleDriveClientId">Client ID</label>
          <input type="text" id="googleDriveClientId" placeholder="输入 Google OAuth Client ID">
          <div class="form-hint">
            <a href="https://console.cloud.google.com/apis/credentials" target="_blank">获取 Client ID</a>
          </div>
          <button type="button" class="btn-secondary" id="googleDriveAuthBtn">认证</button>
          <button type="button" class="btn-secondary" id="googleDriveLogoutBtn">登出</button>
          <div id="googleDriveStatus" class="service-status"></div>
        </div>

        <!-- Notion 设置 -->
        <div class="form-group">
          <h3>Notion</h3>
          <label for="notionApiKey">Integration Token</label>
          <input type="password" id="notionApiKey" placeholder="输入 Notion Integration Token">
          <div class="form-hint">
            <a href="https://www.notion.so/my-integrations" target="_blank">创建 Integration</a>
          </div>
          <label for="notionDatabaseId">Database ID（可选）</label>
          <input type="text" id="notionDatabaseId" placeholder="输入 Notion Database ID">
          <label class="checkbox-label" for="notionUseMcp">
            <input type="checkbox" id="notionUseMcp">
            使用 MCP 调用 Notion
          </label>
          <label for="notionMcpServerUrl">MCP Server URL</label>
          <input type="text" id="notionMcpServerUrl" placeholder="https://your-mcp-server/mcp">
          <label for="notionMcpApiKey">MCP API Key（可选）</label>
          <input type="password" id="notionMcpApiKey" placeholder="可选">
          <label for="notionMcpToolName">MCP Tool Name（可选）</label>
          <input type="text" id="notionMcpToolName" placeholder="notion-create-pages">
          <div class="form-hint">启用 MCP 后将通过 MCP Server 调用 Notion 工具</div>
          <button type="button" class="btn-secondary" id="saveNotionConfigBtn">保存配置</button>
          <div id="notionStatus" class="service-status"></div>
        </div>

        <!-- Obsidian 设置 -->
        <div class="form-group">
          <h3>Obsidian</h3>
          <label for="obsidianVaultPath">仓库路径（可选）</label>
          <input type="text" id="obsidianVaultPath" placeholder="留空则使用 URI 协议">
          <div class="form-hint">如果留空，将通过 Obsidian URI 协议打开新笔记</div>
          <button type="button" class="btn-secondary" id="saveObsidianConfigBtn">保存配置</button>
          <div id="obsidianStatus" class="service-status"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="closeCloudSettingsBtn2">关闭</button>
      </div>
    </div>
  </div>

  <script src="backup-handle-storage.js"></script>
  <script src="storage.js"></script>
  <script src="image-storage.js"></script>
  <script src="error-handler.js"></script>
  <script src="common.js"></script>
  <script src="mcp-notion.js"></script>
  <script src="cloud-services.js"></script>
  <script src="sidebar.js"></script>
</body>
</html>
