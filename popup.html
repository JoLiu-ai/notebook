<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>知识笔记</title>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-left">
        <h1>📝 知识笔记</h1>
        <div class="view-tabs">
          <button class="tab-btn active" id="notesTab" data-view="notes">笔记</button>
          <button class="tab-btn" id="libraryTab" data-view="library">文档库</button>
        </div>
      </div>
      <div class="header-actions">
        <button id="exportBtn" class="btn-icon" title="导出数据">📥</button>
        <button id="addNoteBtn" class="btn-icon" title="添加笔记">+</button>
      </div>
    </header>

    <div class="view-content" id="notesView">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜索笔记...">
      </div>

      <div class="notes-container" id="notesContainer">
        <!-- 笔记列表将在这里动态生成 -->
      </div>

      <div class="empty-state" id="emptyState">
        <p>还没有笔记</p>
        <p class="hint">点击"添加笔记"或使用快捷键保存当前页面内容</p>
      </div>
    </div>

    <div class="view-content hidden" id="libraryView">
      <div class="library-stats">
        <div class="stat-item">
          <div class="stat-value" id="totalNotes">0</div>
          <div class="stat-label">总笔记数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalImages">0</div>
          <div class="stat-label">总图片数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="storageSize">0 KB</div>
          <div class="stat-label">存储大小</div>
        </div>
      </div>

      <div class="library-list" id="libraryList">
        <!-- 文档库列表将在这里显示 -->
      </div>
    </div>
  </div>

  <!-- 添加笔记弹窗 -->
  <div class="modal" id="addNoteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>添加笔记</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="noteTitle">标题</label>
          <input type="text" id="noteTitle" placeholder="输入笔记标题">
        </div>
        <div class="form-group">
          <label for="noteUrl">网址</label>
          <input type="text" id="noteUrl" placeholder="自动填充当前页面网址">
        </div>
        <div class="form-group form-group-textarea">
          <label for="noteText">文本内容</label>
          <textarea id="noteText" rows="6" placeholder="输入或粘贴文本内容..."></textarea>
        </div>
        <div class="form-group">
          <label for="noteCategory">分类</label>
          <input type="text" id="noteCategory" placeholder="输入分类（可选）" list="categoryList">
          <datalist id="categoryList"></datalist>
        </div>
        <div class="form-group">
          <label for="noteTags">标签</label>
          <div class="tags-input-container">
            <input type="text" id="noteTagsInput" placeholder="输入标签，按回车添加" class="tags-input">
            <div class="tags-display" id="tagsDisplay"></div>
          </div>
        </div>
        <div class="form-group">
          <label>图片</label>
          <div class="image-upload-area" id="imageUploadArea">
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
            <button type="button" id="selectImageBtn" class="btn-secondary">选择图片</button>
            <div class="image-preview" id="imagePreview"></div>
          </div>
        </div>
        <div class="form-group">
          <button type="button" id="capturePageBtn" class="btn-secondary">📸 捕获当前页面</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelBtn">取消</button>
        <button class="btn-primary" id="saveNoteBtn">保存</button>
      </div>
    </div>
  </div>

  <!-- 查看笔记详情弹窗 -->
  <div class="modal" id="viewNoteModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-actions">
          <button class="btn-secondary modal-icon-btn" id="editNoteBtn" title="编辑" aria-label="编辑">✎</button>
          <button class="btn-danger modal-icon-btn" id="deleteNoteBtn" title="删除" aria-label="删除">🗑</button>
          <button class="btn-secondary modal-icon-btn" id="closeViewBtn" title="关闭" aria-label="关闭">×</button>
        </div>
        <h2 id="viewNoteTitle"></h2>
      </div>
      <div class="modal-body" id="viewNoteBody">
        <!-- 笔记详情将在这里显示 -->
      </div>
    </div>
  </div>


  <!-- 下载数据弹窗 -->
  <div class="modal" id="downloadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="downloadModalTitle">下载数据</h2>
        <button class="close-btn" id="closeDownloadModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" id="downloadModeRow">
          <label for="downloadModeSelect">下载方式</label>
          <select id="downloadModeSelect">
            <option value="batch">批量下载（每条笔记一个文件）</option>
            <option value="merged">合并下载（所有笔记一个文件）</option>
          </select>
          <div class="form-hint">批量下载可能触发浏览器多文件下载提示。</div>
        </div>
        <div class="form-group">
          <label for="downloadFormatSelect">文件格式</label>
          <select id="downloadFormatSelect"></select>
        </div>
        <div class="form-group" id="downloadImagesRow">
          <label class="checkbox-label">
            <input type="checkbox" id="downloadIncludeImages">
            包含图片（文件会更大）
          </label>
        </div>
        <div class="form-group" id="cloudServiceRow">
          <label>导出到云服务</label>
          <div class="cloud-services-buttons">
            <button type="button" class="btn-cloud-service" id="exportToGoogleDriveBtn" title="导出到 Google Drive">
              📁 Google Drive
            </button>
            <button type="button" class="btn-cloud-service" id="exportToNotionBtn" title="导出到 Notion">
              📝 Notion
            </button>
            <button type="button" class="btn-cloud-service" id="exportToObsidianBtn" title="导出到 Obsidian">
              🔗 Obsidian
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cloudSettingsBtn">云服务设置</button>
        <button class="btn-secondary" id="cancelDownloadBtn">取消</button>
        <button class="btn-primary" id="confirmDownloadBtn">开始下载</button>
      </div>
    </div>
  </div>

  <!-- 云服务设置弹窗（简化版，在 popup 中只显示基本配置） -->
  <div class="modal" id="cloudSettingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>云服务设置</h2>
        <button class="close-btn" id="closeCloudSettingsBtn">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: #666;">完整设置请在侧边栏中配置</p>
        <div class="form-group">
          <h3>Google Drive</h3>
          <button type="button" class="btn-secondary" id="googleDriveAuthBtn">认证</button>
          <div id="googleDriveStatus" class="service-status"></div>
        </div>
        <div class="form-group">
          <h3>Notion</h3>
          <label for="notionApiKey">Integration Token</label>
          <input type="password" id="notionApiKey" placeholder="输入 Notion Integration Token">
          <label class="checkbox-label" for="notionUseMcp">
            <input type="checkbox" id="notionUseMcp">
            使用 MCP 调用 Notion
          </label>
          <label for="notionMcpServerUrl">MCP Server URL</label>
          <input type="text" id="notionMcpServerUrl" placeholder="https://your-mcp-server/mcp">
          <label for="notionMcpApiKey">MCP API Key（可选）</label>
          <input type="password" id="notionMcpApiKey" placeholder="可选">
          <label for="notionMcpToolName">MCP Tool Name（可选）</label>
          <input type="text" id="notionMcpToolName" placeholder="notion-create-pages">
          <button type="button" class="btn-secondary" id="saveNotionConfigBtn">保存</button>
          <div id="notionStatus" class="service-status"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="closeCloudSettingsBtn2">关闭</button>
      </div>
    </div>
  </div>

  <script src="backup-handle-storage.js"></script>
  <script src="storage.js"></script>
  <script src="image-storage.js"></script>
  <script src="error-handler.js"></script>
  <script src="common.js"></script>
  <script src="mcp-notion.js"></script>
  <script src="cloud-services.js"></script>
  <script src="popup.js"></script>
</body>
</html>
